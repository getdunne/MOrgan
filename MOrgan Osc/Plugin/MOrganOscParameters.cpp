#include "MOrganOscParameters.h"

// Drawbar-16
const String MOrganOscParameters::drawbar1ID = "drawbar1";
const String MOrganOscParameters::drawbar1Name = TRANS("16");
const String MOrganOscParameters::drawbar1Label = "%";
const float MOrganOscParameters::drawbar1Min = 0.0f;
const float MOrganOscParameters::drawbar1Max = 100.0f;
const float MOrganOscParameters::drawbar1Default = 0.0f;
const float MOrganOscParameters::drawbar1Step = 0.0f;
// Drawbar-5-13
const String MOrganOscParameters::drawbar2ID = "drawbar2";
const String MOrganOscParameters::drawbar2Name = TRANS("5-1_3");
const String MOrganOscParameters::drawbar2Label = "%";
const float MOrganOscParameters::drawbar2Min = 0.0f;
const float MOrganOscParameters::drawbar2Max = 100.0f;
const float MOrganOscParameters::drawbar2Default = 0.0f;
const float MOrganOscParameters::drawbar2Step = 0.0f;
// Drawbar-8
const String MOrganOscParameters::drawbar3ID = "drawbar3";
const String MOrganOscParameters::drawbar3Name = TRANS("8");
const String MOrganOscParameters::drawbar3Label = "%";
const float MOrganOscParameters::drawbar3Min = 0.0f;
const float MOrganOscParameters::drawbar3Max = 100.0f;
const float MOrganOscParameters::drawbar3Default = 100.0f;
const float MOrganOscParameters::drawbar3Step = 0.0f;
// Drawbar-4
const String MOrganOscParameters::drawbar4ID = "drawbar4";
const String MOrganOscParameters::drawbar4Name = TRANS("4");
const String MOrganOscParameters::drawbar4Label = "%";
const float MOrganOscParameters::drawbar4Min = 0.0f;
const float MOrganOscParameters::drawbar4Max = 100.0f;
const float MOrganOscParameters::drawbar4Default = 0.0f;
const float MOrganOscParameters::drawbar4Step = 0.0f;
// Drawbar-2-23
const String MOrganOscParameters::drawbar5ID = "drawbar5";
const String MOrganOscParameters::drawbar5Name = TRANS("2-2_3");
const String MOrganOscParameters::drawbar5Label = "%";
const float MOrganOscParameters::drawbar5Min = 0.0f;
const float MOrganOscParameters::drawbar5Max = 100.0f;
const float MOrganOscParameters::drawbar5Default = 0.0f;
const float MOrganOscParameters::drawbar5Step = 0.0f;
// Drawbar-2
const String MOrganOscParameters::drawbar6ID = "drawbar6";
const String MOrganOscParameters::drawbar6Name = TRANS("2");
const String MOrganOscParameters::drawbar6Label = "%";
const float MOrganOscParameters::drawbar6Min = 0.0f;
const float MOrganOscParameters::drawbar6Max = 100.0f;
const float MOrganOscParameters::drawbar6Default = 0.0f;
const float MOrganOscParameters::drawbar6Step = 0.0f;
// Drawbar1-35
const String MOrganOscParameters::drawbar7ID = "drawbar7";
const String MOrganOscParameters::drawbar7Name = TRANS("1-3_5");
const String MOrganOscParameters::drawbar7Label = "%";
const float MOrganOscParameters::drawbar7Min = 0.0f;
const float MOrganOscParameters::drawbar7Max = 100.0f;
const float MOrganOscParameters::drawbar7Default = 0.0f;
const float MOrganOscParameters::drawbar7Step = 0.0f;
// Drawbar1-13
const String MOrganOscParameters::drawbar8ID = "drawbar8";
const String MOrganOscParameters::drawbar8Name = TRANS("1-1_3");
const String MOrganOscParameters::drawbar8Label = "%";
const float MOrganOscParameters::drawbar8Min = 0.0f;
const float MOrganOscParameters::drawbar8Max = 100.0f;
const float MOrganOscParameters::drawbar8Default = 0.0f;
const float MOrganOscParameters::drawbar8Step = 0.0f;
// Drawbar1
const String MOrganOscParameters::drawbar9ID = "drawbar9";
const String MOrganOscParameters::drawbar9Name = TRANS("1");
const String MOrganOscParameters::drawbar9Label = "%";
const float MOrganOscParameters::drawbar9Min = 0.0f;
const float MOrganOscParameters::drawbar9Max = 100.0f;
const float MOrganOscParameters::drawbar9Default = 0.0f;
const float MOrganOscParameters::drawbar9Step = 0.0f;
// Amp Attack Time
const String MOrganOscParameters::ampAttackID = "ampAttack";
const String MOrganOscParameters::ampAttackName = TRANS("Attack");
const String MOrganOscParameters::ampAttackLabel = "sec";
const float MOrganOscParameters::ampAttackMin = 0.0f;
const float MOrganOscParameters::ampAttackMax = 1.0f;
const float MOrganOscParameters::ampAttackDefault = 0.01f;
const float MOrganOscParameters::ampAttackStep = 0.001f;
// Amp Decay Time
const String MOrganOscParameters::ampDecayID = "ampDecay";
const String MOrganOscParameters::ampDecayName = TRANS("Decay");
const String MOrganOscParameters::ampDecayLabel = "sec";
const float MOrganOscParameters::ampDecayMin = 0.0f;
const float MOrganOscParameters::ampDecayMax = 1.0f;
const float MOrganOscParameters::ampDecayDefault = 0.0f;
const float MOrganOscParameters::ampDecayStep = 0.001f;
// Amp Sustain Level
const String MOrganOscParameters::ampSustainID = "ampSustain";
const String MOrganOscParameters::ampSustainName = TRANS("Sustain");
const String MOrganOscParameters::ampSustainLabel = "%";
const float MOrganOscParameters::ampSustainMin = 0.0f;
const float MOrganOscParameters::ampSustainMax = 100.0f;
const float MOrganOscParameters::ampSustainDefault = 100.0f;
const float MOrganOscParameters::ampSustainStep = 0.001f;
// Amp Release Time
const String MOrganOscParameters::ampReleaseID = "ampRelease";
const String MOrganOscParameters::ampReleaseName = TRANS("Release");
const String MOrganOscParameters::ampReleaseLabel = "sec";
const float MOrganOscParameters::ampReleaseMin = 0.0f;
const float MOrganOscParameters::ampReleaseMax = 1.0f;
const float MOrganOscParameters::ampReleaseDefault = 0.05f;
const float MOrganOscParameters::ampReleaseStep = 0.001f;
// Master Volume
const String MOrganOscParameters::masterVolumeID = "masterVolume";
const String MOrganOscParameters::masterVolumeName = TRANS("Volume");
const String MOrganOscParameters::masterVolumeLabel = "dB";
const float MOrganOscParameters::masterVolumeMin = -48.0f;
const float MOrganOscParameters::masterVolumeMax = 18.0f;
const float MOrganOscParameters::masterVolumeDefault = 0.0f;
const float MOrganOscParameters::masterVolumeStep = 0.1f;

AudioProcessorValueTreeState::ParameterLayout MOrganOscParameters::createParameterLayout()
{
    std::vector<std::unique_ptr<RangedAudioParameter>> params;

    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar1ID, drawbar1Name,
        NormalisableRange<float>(drawbar1Min, drawbar1Max, drawbar1Step), drawbar1Default,
        drawbar1Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar2ID, drawbar2Name,
        NormalisableRange<float>(drawbar2Min, drawbar2Max, drawbar2Step), drawbar2Default,
        drawbar2Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar3ID, drawbar3Name,
        NormalisableRange<float>(drawbar3Min, drawbar3Max, drawbar3Step), drawbar3Default,
        drawbar3Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar4ID, drawbar4Name,
        NormalisableRange<float>(drawbar4Min, drawbar4Max, drawbar4Step), drawbar4Default,
        drawbar4Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar5ID, drawbar5Name,
        NormalisableRange<float>(drawbar5Min, drawbar5Max, drawbar5Step), drawbar5Default,
        drawbar5Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar6ID, drawbar6Name,
        NormalisableRange<float>(drawbar6Min, drawbar6Max, drawbar6Step), drawbar6Default,
        drawbar6Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar7ID, drawbar7Name,
        NormalisableRange<float>(drawbar7Min, drawbar7Max, drawbar7Step), drawbar7Default,
        drawbar7Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar8ID, drawbar8Name,
        NormalisableRange<float>(drawbar8Min, drawbar8Max, drawbar8Step), drawbar8Default,
        drawbar8Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        drawbar9ID, drawbar9Name,
        NormalisableRange<float>(drawbar9Min, drawbar9Max, drawbar9Step), drawbar9Default,
        drawbar9Label,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        ampAttackID, ampAttackName,
        NormalisableRange<float>(ampAttackMin, ampAttackMax, ampAttackStep), ampAttackDefault,
        ampAttackLabel,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        ampDecayID, ampDecayName,
        NormalisableRange<float>(ampDecayMin, ampDecayMax, ampDecayStep), ampDecayDefault,
        ampDecayLabel,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        ampSustainID, ampSustainName,
        NormalisableRange<float>(ampSustainMin, ampSustainMax, ampSustainStep), ampSustainDefault,
        ampSustainLabel,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        ampReleaseID, ampReleaseName,
        NormalisableRange<float>(ampReleaseMin, ampReleaseMax, ampReleaseStep), ampReleaseDefault,
        ampReleaseLabel,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));
    params.push_back(std::make_unique<AudioParameterFloat>(
        masterVolumeID, masterVolumeName,
        NormalisableRange<float>(masterVolumeMin, masterVolumeMax, masterVolumeStep), masterVolumeDefault,
        masterVolumeLabel,
        AudioProcessorParameter::genericParameter,
        [](float value, int maxLength) { return String(value).substring(0, maxLength); },
        [](const String& text) { return text.getFloatValue(); }));

    return { params.begin(), params.end() };
}

MOrganOscParameters::MOrganOscParameters(AudioProcessorValueTreeState& vts,
                                           AudioProcessorValueTreeState::Listener* processor)
    : drawbar1(0.01f * drawbar1Default)
    , drawbar2(0.01f * drawbar2Default)
    , drawbar3(0.01f * drawbar3Default)
    , drawbar4(0.01f * drawbar4Default)
    , drawbar5(0.01f * drawbar5Default)
    , drawbar6(0.01f * drawbar6Default)
    , drawbar7(0.01f * drawbar7Default)
    , drawbar8(0.01f * drawbar8Default)
    , drawbar9(0.01f * drawbar9Default)
    , ampAttackSec(ampAttackDefault)
    , ampDecaySec(ampDecayDefault)
    , ampSustainLevel(0.01f * ampSustainDefault)
    , ampReleaseSec(ampReleaseDefault)
    , masterVolFraction(1.0f)
    , valueTreeState(vts)
    , processorAsListener(processor)
    , drawbar1Listener(drawbar1, 0.01f)
    , drawbar2Listener(drawbar2, 0.01f)
    , drawbar3Listener(drawbar3, 0.01f)
    , drawbar4Listener(drawbar4, 0.01f)
    , drawbar5Listener(drawbar5, 0.01f)
    , drawbar6Listener(drawbar6, 0.01f)
    , drawbar7Listener(drawbar7, 0.01f)
    , drawbar8Listener(drawbar8, 0.01f)
    , drawbar9Listener(drawbar9, 0.01f)
    , ampAttackListener(ampAttackSec)
    , ampDecayListener(ampDecaySec)
    , ampSustainListener(ampSustainLevel, 0.01f)
    , ampReleaseListener(ampReleaseSec)
    , masterVolumeListener(masterVolFraction, masterVolumeMin)
{
    valueTreeState.addParameterListener(drawbar1ID, processorAsListener);
    valueTreeState.addParameterListener(drawbar2ID, processorAsListener);
    valueTreeState.addParameterListener(drawbar3ID, processorAsListener);
    valueTreeState.addParameterListener(drawbar4ID, processorAsListener);
    valueTreeState.addParameterListener(drawbar5ID, processorAsListener);
    valueTreeState.addParameterListener(drawbar6ID, processorAsListener);
    valueTreeState.addParameterListener(drawbar7ID, processorAsListener);
    valueTreeState.addParameterListener(drawbar8ID, processorAsListener);
    valueTreeState.addParameterListener(drawbar9ID, processorAsListener);
    valueTreeState.addParameterListener(ampAttackID, processorAsListener);
    valueTreeState.addParameterListener(ampDecayID, processorAsListener);
    valueTreeState.addParameterListener(ampSustainID, processorAsListener);
    valueTreeState.addParameterListener(ampReleaseID, processorAsListener);
    valueTreeState.addParameterListener(masterVolumeID, processorAsListener);

    valueTreeState.addParameterListener(drawbar1ID, &drawbar1Listener);
    valueTreeState.addParameterListener(drawbar2ID, &drawbar2Listener);
    valueTreeState.addParameterListener(drawbar3ID, &drawbar3Listener);
    valueTreeState.addParameterListener(drawbar4ID, &drawbar4Listener);
    valueTreeState.addParameterListener(drawbar5ID, &drawbar5Listener);
    valueTreeState.addParameterListener(drawbar6ID, &drawbar6Listener);
    valueTreeState.addParameterListener(drawbar7ID, &drawbar7Listener);
    valueTreeState.addParameterListener(drawbar8ID, &drawbar8Listener);
    valueTreeState.addParameterListener(drawbar9ID, &drawbar9Listener);
    valueTreeState.addParameterListener(ampAttackID, &ampAttackListener);
    valueTreeState.addParameterListener(ampDecayID, &ampDecayListener);
    valueTreeState.addParameterListener(ampSustainID, &ampSustainListener);
    valueTreeState.addParameterListener(ampReleaseID, &ampReleaseListener);
    valueTreeState.addParameterListener(masterVolumeID, &masterVolumeListener);
}

MOrganOscParameters::~MOrganOscParameters()
{
    detachControls();
    
    valueTreeState.removeParameterListener(drawbar1ID, processorAsListener);
    valueTreeState.removeParameterListener(drawbar2ID, processorAsListener);
    valueTreeState.removeParameterListener(drawbar3ID, processorAsListener);
    valueTreeState.removeParameterListener(drawbar4ID, processorAsListener);
    valueTreeState.removeParameterListener(drawbar5ID, processorAsListener);
    valueTreeState.removeParameterListener(drawbar6ID, processorAsListener);
    valueTreeState.removeParameterListener(drawbar7ID, processorAsListener);
    valueTreeState.removeParameterListener(drawbar8ID, processorAsListener);
    valueTreeState.removeParameterListener(drawbar9ID, processorAsListener);
    valueTreeState.removeParameterListener(ampAttackID, processorAsListener);
    valueTreeState.removeParameterListener(ampDecayID, processorAsListener);
    valueTreeState.removeParameterListener(ampSustainID, processorAsListener);
    valueTreeState.removeParameterListener(ampReleaseID, processorAsListener);
    valueTreeState.removeParameterListener(masterVolumeID, processorAsListener);

    valueTreeState.removeParameterListener(drawbar1ID, &drawbar1Listener);
    valueTreeState.removeParameterListener(drawbar2ID, &drawbar2Listener);
    valueTreeState.removeParameterListener(drawbar3ID, &drawbar3Listener);
    valueTreeState.removeParameterListener(drawbar4ID, &drawbar4Listener);
    valueTreeState.removeParameterListener(drawbar5ID, &drawbar5Listener);
    valueTreeState.removeParameterListener(drawbar6ID, &drawbar6Listener);
    valueTreeState.removeParameterListener(drawbar7ID, &drawbar7Listener);
    valueTreeState.removeParameterListener(drawbar8ID, &drawbar8Listener);
    valueTreeState.removeParameterListener(drawbar9ID, &drawbar9Listener);
    valueTreeState.removeParameterListener(ampAttackID, &ampAttackListener);
    valueTreeState.removeParameterListener(ampDecayID, &ampDecayListener);
    valueTreeState.removeParameterListener(ampSustainID, &ampSustainListener);
    valueTreeState.removeParameterListener(ampReleaseID, &ampReleaseListener);
    valueTreeState.removeParameterListener(masterVolumeID, &masterVolumeListener);
}

void MOrganOscParameters::detachControls()
{
    drawbar1Attachment.reset(nullptr);
    drawbar2Attachment.reset(nullptr);
    drawbar3Attachment.reset(nullptr);
    drawbar4Attachment.reset(nullptr);
    drawbar5Attachment.reset(nullptr);
    drawbar6Attachment.reset(nullptr);
    drawbar7Attachment.reset(nullptr);
    drawbar8Attachment.reset(nullptr);
    drawbar9Attachment.reset(nullptr);
    ampAttackAttachment.reset(nullptr);
    ampDecayAttachment.reset(nullptr);
    ampSustainAttachment.reset(nullptr);
    ampReleaseAttachment.reset(nullptr);
    masterVolumeAttachment.reset(nullptr);
}

void MOrganOscParameters::attachControls(
    Drawbar& drawBar1,
    Drawbar& drawBar2,
    Drawbar& drawBar3,
    Drawbar& drawBar4,
    Drawbar& drawBar5,
    Drawbar& drawBar6,
    Drawbar& drawBar7,
    Drawbar& drawBar8,
    Drawbar& drawBar9,
    Slider& ampAttackKnob,
    Slider& ampDecayKnob,
    Slider& ampSustainKnob,
    Slider& ampReleaseKnob,
    Slider& masterVolumeKnob )
{
    using CbAt = AudioProcessorValueTreeState::ComboBoxAttachment;
    using SlAt = AudioProcessorValueTreeState::SliderAttachment;
    drawbar1Attachment.reset(new SlAt(valueTreeState, drawbar1ID, drawBar1));
    drawbar2Attachment.reset(new SlAt(valueTreeState, drawbar2ID, drawBar2));
    drawbar3Attachment.reset(new SlAt(valueTreeState, drawbar3ID, drawBar3));
    drawbar4Attachment.reset(new SlAt(valueTreeState, drawbar4ID, drawBar4));
    drawbar5Attachment.reset(new SlAt(valueTreeState, drawbar5ID, drawBar5));
    drawbar6Attachment.reset(new SlAt(valueTreeState, drawbar6ID, drawBar6));
    drawbar7Attachment.reset(new SlAt(valueTreeState, drawbar7ID, drawBar7));
    drawbar8Attachment.reset(new SlAt(valueTreeState, drawbar8ID, drawBar8));
    drawbar9Attachment.reset(new SlAt(valueTreeState, drawbar9ID, drawBar9));
    ampAttackAttachment.reset(new SlAt(valueTreeState, ampAttackID, ampAttackKnob));
    ampDecayAttachment.reset(new SlAt(valueTreeState, ampDecayID, ampDecayKnob));
    ampSustainAttachment.reset(new SlAt(valueTreeState, ampSustainID, ampSustainKnob));
    ampReleaseAttachment.reset(new SlAt(valueTreeState, ampReleaseID, ampReleaseKnob));
    masterVolumeAttachment.reset(new SlAt(valueTreeState, masterVolumeID, masterVolumeKnob));
}
